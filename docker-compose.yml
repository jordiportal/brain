services:
  # ===========================================
  # PostgreSQL con pgvector
  # ===========================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: brain-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-brain}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-brain_secret}
      POSTGRES_DB: ${POSTGRES_DB:-brain_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-brain} -d ${POSTGRES_DB:-brain_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - brain-network

  # ===========================================
  # Redis - Cache y Cola de Tareas
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: brain-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - brain-network

  # ===========================================
  # API Python - LangChain/LangGraph
  # Acceso directo a PostgreSQL (sin Strapi)
  # ===========================================
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    container_name: brain-api
    restart: unless-stopped
    environment:
      # Database - acceso directo
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-brain_db}
      - DATABASE_USER=${POSTGRES_USER:-brain}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-brain_secret}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-brain}:${POSTGRES_PASSWORD:-brain_secret}@postgres:5432/${POSTGRES_DB:-brain_db}
      - REDIS_URL=redis://redis:6379
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://192.168.7.101:11434}
      # Browser config - conectar al browser-service via CDP
      - BROWSER_VNC_HOST=browser
      - BROWSER_CDP_PORT=9222
      - BROWSER_HEADLESS=true
      # Code Execution config
      - CODE_EXECUTION_TIMEOUT=30
      - CODE_EXECUTION_MEMORY_LIMIT=512m
      - CODE_EXECUTION_CPU_LIMIT=1.0
      - DEBUG=${DEBUG:-true}
      # Sandbox manager: env vars passed to per-user containers
      - PROXY_365_URL=${PROXY_365_URL:-http://host.docker.internal:3001}
      - PROXY_365_API_KEY=${PROXY_365_API_KEY:-}
      - BRAIN_API_KEY=${BRAIN_API_KEY:-}
      - SANDBOX_IMAGE=brain-persistent-runner:latest
      - SANDBOX_NETWORK=brain-network
      - SANDBOX_WORKSPACE_BASE=${SANDBOX_WORKSPACE_BASE:-/Users/jordip/Docker/workspace/users}
    volumes:
      - ./services/api/src:/app/src
      - /var/run/docker.sock:/var/run/docker.sock  # Acceso a Docker daemon para code execution
      - ~/Docker/workspace:/workspace  # Workspace compartido accesible desde Mac
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      browser:
        condition: service_healthy
    networks:
      - brain-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ===========================================
  # Browser Service - Chrome + noVNC + CDP
  # Navegador visual accesible desde la web
  # ===========================================
  browser:
    build:
      context: ./services/browser-service
      dockerfile: Dockerfile
    container_name: brain-browser
    restart: unless-stopped
    ports:
      - "${BROWSER_VNC_PORT:-6080}:6080"   # noVNC (web interface)
      - "${BROWSER_CDP_PORT:-9223}:9223"   # Chrome DevTools Protocol (via socat proxy)
    networks:
      - brain-network
    # Necesario para Chromium en Docker
    ipc: host
    security_opt:
      - seccomp=unconfined
    shm_size: '2gb'
    # Recursos para el navegador
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # Persistent Python Runner - Shared fallback + image builder
  # Per-user sandboxes are created dynamically by SandboxManager
  # using this same image (brain-persistent-runner:latest).
  # ===========================================
  persistent-runner:
    build:
      context: ./services/code-runners
      dockerfile: Dockerfile.persistent-python
    image: brain-persistent-runner:latest
    container_name: brain-persistent-runner
    restart: unless-stopped
    environment:
      - WORKSPACE=/workspace
      - DATABASE_URL=postgresql://${POSTGRES_USER:-brain}:${POSTGRES_PASSWORD:-brain_secret}@postgres:5432/${POSTGRES_DB:-brain_db}
      - REDIS_URL=redis://redis:6379
      - API_URL=http://api:8000
      - PROXY_365_URL=${PROXY_365_URL:-http://host.docker.internal:3001}
      - PROXY_365_API_KEY=${PROXY_365_API_KEY:-}
      - BRAIN_API_KEY=${BRAIN_API_KEY:-}
    volumes:
      - ~/Docker/workspace:/workspace
    networks:
      - brain-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # Angular GUI
  # ===========================================
  gui:
    build:
      context: ./services/gui
      dockerfile: Dockerfile
      target: development
    container_name: brain-gui
    restart: unless-stopped
    environment:
      - API_URL=http://api:8000
    volumes:
      - ./services/gui:/app
      - gui_node_modules:/app/node_modules
    ports:
      - "${GUI_PORT:-4200}:4200"
    depends_on:
      - api
    networks:
      - brain-network

# ===========================================
# Vol√∫menes Persistentes
# ===========================================
volumes:
  postgres_data:
    name: brain-postgres-data
  redis_data:
    name: brain-redis-data
  gui_node_modules:
    name: brain-gui-node-modules
  # persistent_workspace eliminado - ahora usa bind mount ~/Docker/workspace

# ===========================================
# Red Interna
# ===========================================
networks:
  brain-network:
    name: brain-network
    driver: bridge
