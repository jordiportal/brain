version: '3.8'

# ===========================================
# Brain - Production Deployment
# Portainer Stack: brain-stack
# ===========================================

services:
  # ===========================================
  # PostgreSQL con pgvector
  # ===========================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: brain-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-brain}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-brain_secret}
      POSTGRES_DB: ${POSTGRES_DB:-brain_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - brain-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-brain} -d ${POSTGRES_DB:-brain_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Redis - Cache
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: brain-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - brain-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Strapi CMS
  # ===========================================
  strapi:
    build:
      context: ./services/strapi
      dockerfile: Dockerfile
    image: brain-strapi:v1.0.0
    container_name: brain-strapi
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_CLIENT: postgres
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${POSTGRES_DB:-brain_db}
      DATABASE_USERNAME: ${POSTGRES_USER:-brain}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-brain_secret}
      JWT_SECRET: ${JWT_SECRET:-change-me}
      ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET:-change-me}
      APP_KEYS: ${APP_KEYS:-key1,key2,key3,key4}
      API_TOKEN_SALT: ${API_TOKEN_SALT:-change-me}
      TRANSFER_TOKEN_SALT: ${TRANSFER_TOKEN_SALT:-change-me}
    ports:
      - "1337:1337"
    volumes:
      - strapi_uploads:/app/public/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - brain-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:1337/_health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # API Python - LangChain/LangGraph
  # ===========================================
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    image: brain-api:v1.0.0
    container_name: brain-api
    restart: unless-stopped
    environment:
      DEBUG: "false"
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${POSTGRES_DB:-brain_db}
      DATABASE_USER: ${POSTGRES_USER:-brain}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-brain_secret}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STRAPI_URL: http://strapi:1337
      STRAPI_PUBLIC_URL: ${STRAPI_PUBLIC_URL:-http://192.168.7.102:1337}
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN:-change-me}
      BROWSER_VNC_HOST: browser-service
      BROWSER_VNC_PORT: 6080
      MCP_PLAYWRIGHT_URL: http://mcp-playwright:3001
    ports:
      - "8001:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      strapi:
        condition: service_started
    networks:
      - brain-network
    command: ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]

  # ===========================================
  # Browser Service - Chrome con VNC
  # ===========================================
  browser-service:
    build:
      context: ./services/browser-service
      dockerfile: Dockerfile
    image: brain-browser-service:v1.0.0
    container_name: brain-browser-service
    restart: unless-stopped
    environment:
      DISPLAY_WIDTH: 1920
      DISPLAY_HEIGHT: 1080
      VNC_PASSWORD: ""
    ports:
      - "6080:6080"
      - "9222:9222"
    networks:
      - brain-network
    shm_size: 2gb

  # ===========================================
  # GUI - Angular Frontend
  # ===========================================
  gui:
    build:
      context: ./services/gui
      dockerfile: Dockerfile
      target: production
    image: brain-gui:v1.0.0
    container_name: brain-gui
    restart: unless-stopped
    environment:
      API_PUBLIC_URL: ${API_PUBLIC_URL:-http://192.168.7.102:8000}
      STRAPI_PUBLIC_URL: ${STRAPI_PUBLIC_URL:-http://192.168.7.102:1337}
    ports:
      - "4200:80"
    depends_on:
      - api
      - strapi
    networks:
      - brain-network

# ===========================================
# Volumes
# ===========================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  strapi_uploads:
    driver: local

# ===========================================
# Networks
# ===========================================
networks:
  brain-network:
    driver: bridge
