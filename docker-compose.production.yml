# ===========================================
# Brain - Production Deployment
# Portainer Stack: brain-stack
# Acceso directo a PostgreSQL (sin Strapi)
# ===========================================

services:
  # ===========================================
  # PostgreSQL con pgvector
  # ===========================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: brain-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-brain}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-brain_secret}
      POSTGRES_DB: ${POSTGRES_DB:-brain_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
    networks:
      - brain-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-brain} -d ${POSTGRES_DB:-brain_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Redis - Cache
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: brain-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - brain-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # API Python - LangChain/LangGraph
  # Acceso directo a PostgreSQL
  # ===========================================
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    image: brain-api:v1.0.0
    container_name: brain-api
    restart: unless-stopped
    environment:
      DEBUG: "false"
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${POSTGRES_DB:-brain_db}
      DATABASE_USER: ${POSTGRES_USER:-brain}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-brain_secret}
      DATABASE_URL: postgresql://${POSTGRES_USER:-brain}:${POSTGRES_PASSWORD:-brain_secret}@postgres:5432/${POSTGRES_DB:-brain_db}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_URL: redis://redis:6379
      BROWSER_VNC_HOST: browser-service
      BROWSER_VNC_PORT: 6080
      MCP_PLAYWRIGHT_URL: http://mcp-playwright:3001
    ports:
      - "8001:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - brain-network
    command: ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]

  # ===========================================
  # Browser Service - Chrome con VNC
  # ===========================================
  browser-service:
    build:
      context: ./services/browser-service
      dockerfile: Dockerfile
    image: brain-browser-service:v1.0.0
    container_name: brain-browser-service
    restart: unless-stopped
    environment:
      DISPLAY_WIDTH: 1920
      DISPLAY_HEIGHT: 1080
      VNC_PASSWORD: ""
    ports:
      - "6080:6080"
      - "9222:9222"
    networks:
      - brain-network
    shm_size: 2gb

  # ===========================================
  # GUI - Angular Frontend
  # ===========================================
  gui:
    build:
      context: ./services/gui
      dockerfile: Dockerfile
      target: production
    image: brain-gui:v1.0.0
    container_name: brain-gui
    restart: unless-stopped
    environment:
      API_PUBLIC_URL: ${API_PUBLIC_URL:-http://192.168.7.102:8000}
    ports:
      - "4200:80"
    depends_on:
      - api
    networks:
      - brain-network

# ===========================================
# Volumes
# ===========================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

# ===========================================
# Networks
# ===========================================
networks:
  brain-network:
    driver: bridge
